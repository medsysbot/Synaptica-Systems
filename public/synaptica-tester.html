<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Synaptica Systems Tester</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2em;
        }
        #console {
            background: #f5f5f5;
            border: 1px solid #ccc;
            padding: 1em;
            white-space: pre-wrap;
            height: 200px;
            overflow-y: auto;
        }
        label, input, button {
            margin-top: 0.5em;
        }
    </style>
</head>
<body>
    <h1>Tester Automático de Synaptica Systems</h1>
    <label>URL de MedSys:
        <input id="medsys-url" type="text" placeholder="https://midominio.com" size="40">
    </label>

    <h2>Iniciar sesión</h2>
    <label>Usuario:
        <input id="usuario" type="text">
    </label><br>
    <label>Contraseña:
        <input id="contrasena" type="password">
    </label><br>
    <label>Rol:
        <input id="rol" type="text">
    </label><br>
    <button id="login-btn">Iniciar sesión</button>
    <div id="login-message"></div>

    <button id="start-test">Iniciar Test</button>

    <h2>Resultado</h2>
    <div id="console"></div>
    <button id="export-report">Exportar reporte (.txt)</button>

<script>
const consoleArea = document.getElementById('console');
let results = [];
let loginSuccess = false;
let baseUrl = '';

function logResult(text) {
    results.push(text);
    consoleArea.textContent += text + '\n';
}

async function login() {
    baseUrl = document.getElementById('medsys-url').value.trim();
    const usuario = document.getElementById('usuario').value.trim();
    const contrasena = document.getElementById('contrasena').value;
    const rol = document.getElementById('rol').value.trim();

    if (!baseUrl || !usuario || !contrasena || !rol) {
        alert('Completá todos los campos de login');
        return;
    }

    try {
        const resp = await fetch(baseUrl + '/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ usuario, contrasena, rol }),
            credentials: 'include'
        });
        if (!resp.ok) throw new Error();
        loginSuccess = true;
        document.getElementById('login-message').textContent = '✅ Sesión iniciada correctamente';
    } catch (err) {
        loginSuccess = false;
        document.getElementById('login-message').textContent = '❌ Error al iniciar sesión';
    }
}

async function runTests() {
    if (!loginSuccess) {
        alert('Primero iniciá sesión');
        return;
    }
    if (!baseUrl) {
        alert('Ingresá la URL de MedSys');
        return;
    }
    consoleArea.textContent = '';
    results = [];
    await testRegistro(baseUrl);
    await testEvolucion(baseUrl);
    await testHistoria(baseUrl);
    await testReceta(baseUrl);
    logResult('Pruebas finalizadas');
}

async function testRegistro(base) {
    try {
        logResult('Iniciando prueba de Registro...');
        const resp = await fetch(base + '/registro', { credentials: 'include' });
        if (!resp.ok) throw new Error('No se pudo acceder');
        logResult('\u2714\ufe0f Registro: OK');
    } catch (err) {
        logResult('\u274c Registro: ' + err.message);
    }
}

async function testEvolucion(base) {
    try {
        logResult('Iniciando prueba de Evoluci\u00f3n...');
        const resp = await fetch(base + '/evolucion', { credentials: 'include' });
        if (!resp.ok) throw new Error('No se pudo acceder');
        logResult('\u2714\ufe0f Evoluci\u00f3n: OK');
    } catch (err) {
        logResult('\u274c Evoluci\u00f3n: ' + err.message);
    }
}

async function testHistoria(base) {
    try {
        logResult('Iniciando prueba de Historia...');
        const resp = await fetch(base + '/historia', { credentials: 'include' });
        if (!resp.ok) throw new Error('No se pudo acceder');
        logResult('\u2714\ufe0f Historia: OK');
    } catch (err) {
        logResult('\u274c Historia: ' + err.message);
    }
}

async function testReceta(base) {
    try {
        logResult('Iniciando prueba de Receta...');
        const resp = await fetch(base + '/receta', { credentials: 'include' });
        if (!resp.ok) throw new Error('No se pudo acceder');
        logResult('\u2714\ufe0f Receta: OK');
    } catch (err) {
        logResult('\u274c Receta: ' + err.message);
    }
}

function exportReport() {
    const blob = new Blob([results.join('\n')], {type: 'text/plain'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'reporte.txt';
    link.click();
}

document.getElementById('start-test').addEventListener('click', runTests);
document.getElementById('export-report').addEventListener('click', exportReport);
document.getElementById('login-btn').addEventListener('click', login);
</script>
</body>
</html>
