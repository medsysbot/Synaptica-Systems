<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Synaptica Systems Tester</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2em;
        }
        #console {
            background: #f5f5f5;
            border: 1px solid #ccc;
            padding: 1em;
            white-space: pre-wrap;
            height: 200px;
            overflow-y: auto;
        }
        label, input, button {
            margin-top: 0.5em;
        }
    </style>
</head>
<body>
    <h1>Tester Automático de Synaptica Systems</h1>
    <label>URL de MedSys (sesión iniciada):
        <input id="medsys-url" type="text" placeholder="https://midominio.com/index" size="40">
    </label>
    <div id="session-message"></div>
    <iframe id="medsys-frame" src="" style="width:100%; height:500px; border:1px solid #ccc;"></iframe>

    <button id="start-test">Iniciar Test</button>

    <h2>Resultado</h2>
    <div id="console"></div>
    <button id="export-report">Exportar reporte (.txt)</button>

<script>
const consoleArea = document.getElementById('console');
let results = [];
let baseUrl = '';

function logResult(text) {
    results.push(text);
    consoleArea.textContent += text + '\n';
}

function mostrarError(msg) {
    document.getElementById('session-message').textContent = msg;
}

async function iniciarPruebas() {
    baseUrl = document.getElementById('medsys-url').value.trim();
    if (!baseUrl) {
        mostrarError('Ingresá la URL de MedSys');
        return;
    }
    document.getElementById('session-message').textContent = '';
    consoleArea.textContent = '';
    results = [];
    await testRegistro();
    await testEvolucion();
    await testHistoria();
    await testReceta();
    logResult('Pruebas finalizadas');
}

function verificarSesion() {
    baseUrl = document.getElementById('medsys-url').value.trim();
    if (!baseUrl) {
        mostrarError('Ingresá la URL de MedSys');
        return;
    }
    document.getElementById('session-message').textContent = 'Verificando sesión...';
    const frame = document.getElementById('medsys-frame');
    frame.src = baseUrl;
    frame.onload = () => {
        let finalUrl = '';
        try {
            finalUrl = frame.contentWindow.location.href;
        } catch (err) {
            finalUrl = frame.src;
        }
        if (finalUrl.includes('login')) {
            mostrarError('Debe iniciar sesión en otra pestaña.');
        } else {
            document.getElementById('session-message').textContent = '';
            iniciarPruebas();
        }
    };
}

async function esperar(ms) {
    return new Promise(r => setTimeout(r, ms));
}

function esperarCampo(doc, selector, intento = 0) {
    return new Promise((resolve, reject) => {
        const campo = doc.querySelector(selector);
        if (campo) {
            resolve(campo);
        } else if (intento > 20) {
            reject(new Error(`No se encontró el campo ${selector}`));
        } else {
            setTimeout(() => {
                esperarCampo(doc, selector, intento + 1).then(resolve).catch(reject);
            }, 300);
        }
    });
}

async function cargarEnIframe(ruta) {
    return new Promise((resolve, reject) => {
        const frame = document.getElementById('medsys-frame');
        frame.src = baseUrl + ruta;
        frame.onload = () => resolve();
    });
}

async function testRegistro() {
    try {
        logResult('Iniciando prueba de Registro...');
        await cargarEnIframe('/registro');
        const doc = document.getElementById('medsys-frame').contentDocument ||
                    document.getElementById('medsys-frame').contentWindow.document;
        const dni = await esperarCampo(doc, '#dni');
        const nombre = await esperarCampo(doc, '#nombre');
        dni.value = '12345678';
        nombre.value = 'TEST';
        const guardar = await esperarCampo(doc, '#guardar');
        guardar.click();
        await esperar(1000);
        logResult('\u2714\ufe0f Registro: OK');
    } catch (err) {
        logResult('\u274c Registro: ' + err.message);
    }
}

async function testEvolucion() {
    try {
        logResult('Iniciando prueba de Evoluci\u00f3n...');
        await cargarEnIframe('/evolucion');
        const doc = document.getElementById('medsys-frame').contentDocument ||
                    document.getElementById('medsys-frame').contentWindow.document;
        const diagnostico = await esperarCampo(doc, '#diagnostico');
        diagnostico.value = 'Test automatizado';
        const guardar = await esperarCampo(doc, '#guardar');
        guardar.click();
        await esperar(1000);
        logResult('\u2714\ufe0f Evoluci\u00f3n: OK');
    } catch (err) {
        logResult('\u274c Evoluci\u00f3n: ' + err.message);
    }
}

async function testHistoria() {
    try {
        logResult('Iniciando prueba de Historia...');
        await cargarEnIframe('/historia');
        const doc = document.getElementById('medsys-frame').contentDocument ||
                    document.getElementById('medsys-frame').contentWindow.document;
        const obs = await esperarCampo(doc, '#observaciones');
        obs.value = 'Historia automatizada';
        const guardar = await esperarCampo(doc, '#guardar');
        guardar.click();
        await esperar(1000);
        logResult('\u2714\ufe0f Historia: OK');
    } catch (err) {
        logResult('\u274c Historia: ' + err.message);
    }
}

async function testReceta() {
    try {
        logResult('Iniciando prueba de Receta...');
        await cargarEnIframe('/receta');
        const doc = document.getElementById('medsys-frame').contentDocument ||
                    document.getElementById('medsys-frame').contentWindow.document;
        const medicacion = await esperarCampo(doc, '#medicacion');
        medicacion.value = 'Paracetamol';
        const guardar = await esperarCampo(doc, '#guardar');
        guardar.click();
        await esperar(1000);
        logResult('\u2714\ufe0f Receta: OK');
    } catch (err) {
        logResult('\u274c Receta: ' + err.message);
    }
}

function exportReport() {
    const blob = new Blob([results.join('\n')], {type: 'text/plain'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'reporte.txt';
    link.click();
}

document.getElementById('start-test').addEventListener('click', verificarSesion);
document.getElementById('export-report').addEventListener('click', exportReport);
</script>
</body>
</html>
